<template>
  <div class="container">
    <div class="container-config">
      <div class="container-config-item" >
        <label for="ctrlEnableDragNDrop">
          Allow Drag'n'drop
        </label>
        <input
          type="checkbox"
          v-model="ctrlEnableDragNDrop"
          id="ctrlEnableDragNDrop"
        >
      </div>
      <div class="container-config-item config-max-depth">
        <div>
          <label for="ctrlEnableMaxDepth">
            Enable max depth
          </label>
          <input
            type="checkbox"
            v-model="ctrlEnableMaxDepth"
            id="ctrlEnableMaxDepth"
          >
        </div>
        <div>
          <label for="ctrlMaxDepth">
            Max Depth:
          </label>
          <input
            v-model.number="ctrlMaxDepth"
            type="number"
            min="0"
            :disabled="! ctrlEnableMaxDepth"
            id="ctrlMaxDepth"
          >
        </div>
      </div>
      <div class="container-config-item config-slots">
        <div>
          <label for="ctrlEnableGroupOperatorSlot">
            Enable Group Operator Slot
          </label>
          <input
            type="checkbox"
            v-model="ctrlEnableGroupOperatorSlot"
            id="ctrlEnableGroupOperatorSlot"
          >
        </div>
        <div>
          <label for="ctrlEnableGroupControlSlot">
            Enable Group Control Slot
          </label>
          <input
            type="checkbox"
            v-model="ctrlEnableGroupControlSlot"
            id="ctrlEnableGroupControlSlot"
          >
        </div>
        <div>
          <label for="ctrlEnableRuleSlot">
            Enable Rule Slot
          </label>
          <input
            type="checkbox"
            v-model="ctrlEnableRuleSlot"
            id="ctrlEnableRuleSlot"
          >
        </div>
      </div>
    </div>
    <query-builder
      :config="getConfig"
      v-model="query"
      class ="query-builder"
    >
      <template
        v-if="ctrlEnableGroupOperatorSlot"
        #groupOperator="props"
      >
        <div class="query-builder-group-slot__group-selection">
          <span class="query-builder-group-slot__group-operator">Operator: </span>
          <select
            :value="props.currentOperator"
            @input="props.updateCurrentOperator($event.target.value)"
          >
            <option disabled value="">Select an operator</option>
            <option
              v-for="operator in props.operators"
              :key="operator.identifier"
              :value="operator.identifier"
              v-text="operator.name"
            />
          </select>
        </div>
      </template>

      <template
        v-if="ctrlEnableGroupControlSlot"
        #groupControl="props"
      >
        <group-ctrl-slot :group-ctrl="props"/>
      </template>

      <template
        v-if="ctrlEnableRuleSlot"
        #rule="props"
      >
        <rule-slot :ruleCtrl="props"/>
      </template>
    </query-builder>

    <pre>{{ JSON.stringify(this.query, null, 2) }}</pre>

  </div>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator';

import QueryBuilder from '@/QueryBuilder.vue';
import {
  QueryBuilderConfig, RuleSet,
} from '@/types';

import InputSelection from './Input.vue';
import NumberSelection from './Number.vue';
import GroupCtrlSlot from './GroupCtrlSlot.vue';
import RuleSlot from './RuleSlot.vue';
import {RuleConditions, RuleSetComparator} from "../types/constants";

@Component({
  computed: {
  },
  components: {
  QueryBuilder,
  GroupCtrlSlot,
  RuleSlot,
  },
  })
export default class App extends Vue {
ctrlEnableDragNDrop: boolean = true;

  ctrlEnableMaxDepth: boolean = false;

  ctrlMaxDepth: number = 3;

  ctrlEnableGroupOperatorSlot: boolean = true;

  ctrlEnableGroupControlSlot: boolean = true;

  ctrlEnableRuleSlot: boolean = true;

  query: RuleSet | null = {
    comparator: RuleSetComparator.OR,
    children: [
      {
        column: 'FirstName',
        condition: RuleConditions.EQUALS,
        value: 'A',
      },
    ],
  };

  config: QueryBuilderConfig = {
    operators: [
      {
        name: 'AND',
        identifier: RuleSetComparator.AND,
      },
      {
        name: 'OR',
        identifier: RuleSetComparator.OR,
      },
    ],
    rules: [
      {
        column: 'FirstName',
        component: InputSelection,
        initialValue: '',
        conditions: [
          RuleConditions.CONTAINS,
          RuleConditions.EQUALS,
          RuleConditions.NOT_EQUALS,
          RuleConditions.LIKE,
        ],
      },
      {
        column: 'LastName',
        component: InputSelection,
        initialValue: '',
        conditions: [
          RuleConditions.CONTAINS,
          RuleConditions.EQUALS,
          RuleConditions.NOT_EQUALS,
          RuleConditions.LIKE,
        ],
      },
      {
        column: 'CourseId',
        component: NumberSelection,
        initialValue: 1,
        conditions: [
          RuleConditions.EQUALS,
          RuleConditions.NOT_EQUALS,
          RuleConditions.GREATER_THAN,
          RuleConditions.LESS_THAN,
        ],
      },
    ],
    maxDepth: undefined,
    colors: [
      'hsl(88, 50%, 55%)',
      'hsl(187, 100%, 45%)',
      'hsl(15, 100%, 55%)',
    ],
    dragging: {
      animation: 300,
      disabled: false,
      ghostClass: 'ghost',
    },
  }

  get getConfig(): QueryBuilderConfig {
    const config: QueryBuilderConfig = { ...this.config };

    if (!config.dragging) {
      config.dragging = {};
    }
    config.dragging.disabled = !this.ctrlEnableDragNDrop;

    config.maxDepth = Math.abs(this.ctrlMaxDepth || 0);
    if (!this.ctrlEnableMaxDepth) {
      config.maxDepth = undefined;
    }

    return config;
  }
}
</script>

<style lang="scss">

.container {
  width: 90%;
  margin: 30px auto;
  display: flex;
  flex-direction: column;
}

.container-config {
  border: 1px solid hsl(0, 0%, 75%);
  margin-bottom: 30px;
  padding: 10px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
}

.config-max-depth #ctrlMaxDepth {
  width: 70px;
}

.query-builder {
  border: 1px solid hsl(0, 0%, 75%);
}

.query-builder-group-slot__group-selection {
  padding: 16px;
  background-color: hsl(0, 0, 95%);
}
.query-builder-group-slot__group-operator {
  margin-right: 8px;
}
</style>
